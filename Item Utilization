{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# ArcGIS Online Web Application Audit\n",
    "Description: This will audit all of the web applications in an organization.\n",
    " \n",
    "Beginning with: AGOWebApplicationAuditPythonAPI.py\n",
    " \n",
    "Created on: 2/13/2018\n",
    " \n",
    "Purpose: This will audit all of the web applications in an organization,\n",
    "    and provide information about the web maps that are referenced by the application. \n",
    " \n",
    "Authored by: Brandon Longenberger\n",
    " \n",
    "Previous Production Date: 2/13/18     Production Date: 9/3/18"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Connect to ArcGIS Online"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# import\n",
    "from arcgis.gis import GIS\n",
    "from arcgis.gis.server import Server\n",
    "import getpass\n",
    "from IPython.display import display\n",
    "from arcgis.mapping import WebMap\n",
    "import json\n",
    "import requests\n",
    "import time\n",
    "import pandas as pd\n",
    "\n",
    "# Connection Variables\n",
    "Organization = input(\"What's your oranization? \")\n",
    "User = input(\"What's your  username? \")\n",
    "Password = getpass.getpass('Password: ')\n",
    "\n",
    "# Connection \n",
    "gis = GIS(Organization, User, Password)\n",
    "gis\n",
    "WebAppAudit = gis.content.search(query=\"\", item_type=\"Web Mapping Application\", max_items = 10000000)\n",
    "WebMapAudit = gis.content.search(query=\"\", item_type=\"Web Map\", max_items = 10000000)\n",
    "MapList = []"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Audit Section"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Functions\n",
    "def WriteMapInfo(MapID):\n",
    "    global df\n",
    "    MapItemList = gis.content.search(query='id:' + str(MapID))\n",
    "    for MapItem in MapItemList:\n",
    "        \n",
    "        AddToMapList(MapID)\n",
    "        \n",
    "        if Item.access == MapItem.access:\n",
    "            EqualSharing = \"Yes\"\n",
    "        else:\n",
    "            EqualSharing = \"No\"\n",
    "        df = df.append({\n",
    "        'AppTitle':str(Item.title.replace(\",\", \"\")),\n",
    "        'AppID':str(Item.id),\n",
    "        'AppItemType':str(Item.type),\n",
    "        'AppOwner':str(Item.owner),\n",
    "        'AppAccess':str(Item.access),\n",
    "        'MapTitle':str(MapItem.title.replace(\",\", \"\")),\n",
    "        'MapID':str(MapID),\n",
    "        'ItemType':str(MapItem.type),\n",
    "        'MapOwner':str(MapItem.owner),\n",
    "        'MapAccess':str(MapItem.access),\n",
    "        'EqualSharing':EqualSharing\n",
    "        }, ignore_index=True)\n",
    "\n",
    "def GetMedia(Story, Item):\n",
    "    global df\n",
    "    Media = Story.get(\"media\")\n",
    "    if Media != None:\n",
    "        Type = Media.get(\"type\")\n",
    "        if Type == \"webpage\":\n",
    "            Webpage = Media[Type]\n",
    "            Url = Webpage[\"url\"]\n",
    "            df = df.append({\n",
    "            'AppTitle':str(Item.title.replace(\",\", \"\")),\n",
    "            'AppID':str(Item.id),\n",
    "            'AppItemType':str(Item.type),\n",
    "            'AppOwner':str(Item.owner),\n",
    "            'MapTitle':\"Web Page\",\n",
    "            'WebPageUrl':str(Url)\n",
    "            }, ignore_index=True)\n",
    "        if Type == \"webmap\":\n",
    "            Webmap = Media[Type]\n",
    "            \n",
    "            WriteMapInfo(Webmap[\"id\"])\n",
    "\n",
    "def LoopWebMaps(List):\n",
    "    for MapID in List:\n",
    "        WriteMapInfo(MapID)\n",
    "\n",
    "def AddToMapList(MapID):\n",
    "    global MapList\n",
    "    if MapID not in MapList:\n",
    "        MapList += [MapID]\n",
    "\n",
    "# End Function Section\n",
    "\n",
    "dataColumns = ['AppTitle','AppID','AppItemType','AppOwner','AppAccess','WebPageUrl','MapTitle','MapID',\n",
    "               'ItemType','MapOwner','MapAccess','EqualSharing']\n",
    "df = pd.DataFrame(columns = dataColumns)\n",
    "\n",
    "for Item in WebAppAudit:\n",
    "    ItemData = Item.get_data(try_json=True)\n",
    "    if ItemData != None:\n",
    "        Map = ItemData.get(\"map\")\n",
    "        if Map != None:\n",
    "            MapItemID = Map.get(\"itemId\")\n",
    "            WriteMapInfo(MapItemID)\n",
    "        Values = ItemData.get(\"values\")\n",
    "        if Values != None:\n",
    "            WebMap = Values.get(\"webmap\")\n",
    "            if WebMap != None:\n",
    "                if isinstance(WebMap, str):\n",
    "                    Find = WebMap.find(\",\")\n",
    "                    if Find == -1:\n",
    "                        WriteMapInfo(WebMap)\n",
    "                    else:\n",
    "                        Split = WebMap.split(\",\")\n",
    "                        LoopWebMaps(Split)\n",
    "                elif isinstance(WebMap, list):\n",
    "                    LoopWebMaps(WebMap)\n",
    "            Story = Values.get(\"story\")\n",
    "            if Story != None:\n",
    "                Sections = Story.get(\"sections\")\n",
    "                if Sections != None:\n",
    "                    for Section in Sections:\n",
    "                        GetMedia(Section, Item)\n",
    "                Entries = Story.get(\"entries\")\n",
    "                if Entries != None:\n",
    "                    for Entry in Entries:\n",
    "                        GetMedia(Entry, Item)\n",
    "    else:\n",
    "        df = df.append({\n",
    "        'AppTitle':str(Item.title.replace(\",\", \"\")),\n",
    "        'AppID':str(Item.id),\n",
    "        'AppItemType':str(Item.type),\n",
    "        'AppOwner':str(Item.owner)\n",
    "        }, ignore_index=True)\n",
    "\n",
    "df.drop_duplicates(subset=dataColumns,inplace=True)\n",
    "df"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Add Webmaps not in an App to dataframe"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "for Map in WebMapAudit:\n",
    "    if Map.id in MapList:\n",
    "        EqualSharing = \"Yes\"\n",
    "    else:\n",
    "        EqualSharing = \"No\"\n",
    "    df = df.append({\n",
    "    'MapTitle':str(Map.title.replace(\",\", \"\")),\n",
    "    'MapID':str(Map.id),\n",
    "    'MapOwner':str(Map.owner),\n",
    "    'MapAccess':str(Map.access),\n",
    "    'EqualSharing':EqualSharing\n",
    "    }, ignore_index=True)\n",
    "\n",
    "print(\"Webmaps not in an App have been added to dataframe.\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Write the Web App Audit Results to CSV"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "from tkinter.filedialog import asksaveasfilename\n",
    "filename = asksaveasfilename(defaultextension='.csv') # show an \"Open\" dialog box and return the path to the selected file\n",
    "print(filename)\n",
    "df.to_csv(filename, index=False)\n",
    "print(\"Write data To CSV File Complete!\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Comment Apps with Webmaps & vice versa"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# This deletes old comments that start with #WebAppAudit\n",
    "CommentSearch = gis.content.search(query=\"numcomments:[1 TO 999]\", max_items = 10000000)\n",
    "print(\"Found {} items with comments\".format(len(CommentSearch)))\n",
    "for i in CommentSearch:\n",
    "    ItemID = i.id\n",
    "    gisItem = gis.content.get(ItemID)\n",
    "    CommentList = gisItem.comments\n",
    "    for c in CommentList:\n",
    "        comm = (c['comment'])\n",
    "        commID = (c['id'])\n",
    "        if comm[0:12]=='#WebAppAudit':\n",
    "        #if comm[0:11]=='WebAppAudit':\n",
    "            print(\"We will delete this comment: {}\".format(comm))\n",
    "            # Once Esri adds a function to delete comments in the ArcGIS API for Python, that goes here\n",
    "            # Then the following code can be deleted\n",
    "            tokenURL = \"https://www.arcgis.com/sharing/generateToken?username={}&password={}&client=referer&referer=http://www.arcgis.com&expiration=60\".format(User,Password)\n",
    "            data={'f':'json'}\n",
    "            tokenreq=requests.get(tokenURL, data)\n",
    "            resp=tokenreq.json()\n",
    "            tokenid=resp['token']\n",
    "            tokenid\n",
    "            URL=\"{}/sharing/rest/content/items/{}/comments/{}/delete\".format(Organization,ItemID,commID)\n",
    "            params={\"f\":\"json\", \"token\": str(tokenid)}\n",
    "            r=requests.post(URL,params)\n",
    "            r.json()\n",
    "            pastebin_url = r.text\n",
    "            print (pastebin_url)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "#Write a comment for which MAPS are in APPS\n",
    "startTime = datetime.datetime.now()\n",
    "uf = df\n",
    "AppIDs = uf.AppID.unique()\n",
    "CommentCounter = 0\n",
    "for a in AppIDs:\n",
    "    #filter the dataframe to only apps that have maps\n",
    "    af = uf.loc[(uf['AppID']==a) & (~uf['MapID'].isna()), ['MapID','AppTitle','MapTitle']]\n",
    "    MapTitles = af['MapTitle'].tolist()\n",
    "    MapIDs = af['MapID'].tolist()\n",
    "    if MapIDs:\n",
    "        cc = \"#WebAppAudit -- This app: {} contains the map: {}, found here: {}/home/item.html?id={}\".format(a,MapTitles[0],Organization,MapIDs[0])\n",
    "        if len(MapIDs) > 1:\n",
    "            for x in MapIDs[1:]:\n",
    "                i = MapIDs.index(x)\n",
    "                cc += \" and the map: {}, found here: {}/home/item.html?id={}\".format(MapTitles[i],Organization,MapIDs[i])\n",
    "        print (cc)\n",
    "        CommentCounter += 1\n",
    "        wa_item = gis.content.get(a)\n",
    "        time.sleep(1)\n",
    "        wa_item.add_comment(str(cc))\n",
    "        time.sleep(29)\n",
    "\n",
    "print (\"Number of comments written: {}\".format(CommentCounter))\n",
    "endTime = datetime.datetime.now()-startTime\n",
    "print (\"This took {}\".format(endTime))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "#Write a comment for which APPS are using the MAP\n",
    "startTime = datetime.datetime.now()\n",
    "tf = pd.DataFrame(columns = ['AppID','AppTitle','MapTitle','MapID'])\n",
    "umf = df\n",
    "MapIDs = umf.MapID.unique()\n",
    "CommentCounter = 0\n",
    "for m in MapIDs:\n",
    "    #filter the dataframe to only maps that have apps\n",
    "    mf = umf.loc[(umf['MapID']==m) & (~umf['AppID'].isna()), ['AppID','AppTitle','MapTitle']]\n",
    "    AppTitles = mf['AppTitle'].tolist()\n",
    "    AppIDs = mf['AppID'].tolist()\n",
    "    if AppIDs:\n",
    "        cc = \"#WebAppAudit -- This map: {} is in the app: {}, found here: {}/home/item.html?id={}\".format(m,AppTitles[0],Organization,AppIDs[0])\n",
    "        if len(AppIDs) > 1:\n",
    "            for x in AppIDs[1:]:\n",
    "                i = AppIDs.index(x)\n",
    "                cc += \" and the app: {}, found here: {}/home/item.html?id={}\".format(AppTitles[i],Organization,AppIDs[i])\n",
    "        print (cc)\n",
    "        CommentCounter += 1\n",
    "        wa_item = gis.content.get(m)\n",
    "        time.sleep(1)\n",
    "        wa_item.add_comment(str(cc))\n",
    "        time.sleep(29)\n",
    "\n",
    "print (\"Number of comments written: {}\".format(CommentCounter))\n",
    "endTime = datetime.datetime.now()-startTime\n",
    "print (\"This took {}\".format(endTime))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.6.8"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
